<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DIVEIndia – Tomorrow’s Wind & Tide Chalkboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Shadows+Into+Light&display=swap" rel="stylesheet">
  <style>
    :root {
      --board:#1f3d2b; --chalk:#f2f2f2; --accent:#bfe3c0;
      --fs-base:18px; --fs-h1:34px; --fs-h2:26px;
      --fs-chip:18px; --fs-card-title:22px; --fs-card-big:26px;
      --fs-muted:16px; --pad:16px;
    }
    html,body{margin:0;padding:0;background:#0b0f0e;color:var(--chalk);font-family:"Shadows Into Light", system-ui, sans-serif;font-size:var(--fs-base);}
    .wrap{max-width:1200px;margin:0 auto;padding:var(--pad);}
    h1{font-size:var(--fs-h1);letter-spacing:1px;text-align:center;margin:8px 0 12px;}
    .sub{opacity:.85;text-align:center;margin-bottom:12px;font-size:18px}
    .controls{display:flex;justify-content:center;gap:8px;margin:8px 0 16px;}
    .btn{
      font:inherit; color:var(--chalk); background:rgba(255,255,255,.08);
      border:1px dashed rgba(255,255,255,.35); border-radius:12px; padding:6px 12px; cursor:pointer;
    }
    .btn.active{background:rgba(255,255,255,.18)}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:900px){.grid{grid-template-columns:1fr 1fr}}
    .board{
      background:var(--board); color:var(--chalk);
      border:10px solid #4a2f1b; border-radius:18px; padding:16px 18px 20px;
      box-shadow:0 12px 30px rgba(0,0,0,.4), inset 0 0 12px rgba(255,255,255,.06); position:relative;
    }
    .board:before{
      content:""; position:absolute; inset:10px;
      background:radial-gradient(200px 70px at 20% 10%, rgba(255,255,255,.06), transparent 60%),
                 radial-gradient(200px 70px at 80% 90%, rgba(255,255,255,.05), transparent 60%); pointer-events:none;
    }
    .title{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .title h2{margin:0;font-size:var(--fs-h2)}
    .date{font-size:18px;opacity:.9}
    .section{border-top:1px dashed rgba(255,255,255,.25);padding-top:10px;margin-top:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .chip{
      border:1px dashed rgba(255,255,255,.35); border-radius:12px; padding:6px 10px;
      font-size:var(--fs-chip); background:rgba(255,255,255,.06); text-shadow:0 1px 0 rgba(0,0,0,.25);
    }
    .wind-cards{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:520px){.wind-cards{grid-template-columns:1fr 1fr 1fr}}
    .card{
      background:rgba(0,0,0,.15); border:1px dashed rgba(255,255,255,.25);
      border-radius:14px; padding:12px 14px; min-height:100px;
    }
    .card h4{margin:0 0 6px 0;font-size:var(--fs-card-title)}
    .big{font-size:var(--fs-card-big);line-height:1.15}
    .muted{opacity:.85;font-size:var(--fs-muted)}
    .tides{display:grid;grid-template-columns:1fr;gap:10px}
    .badge{display:inline-block;border:1px solid rgba(255,255,255,.35);padding:2px 8px;border-radius:999px;margin-left:6px;font-size:16px}
    .err{color:#ffb3b3}
    .foot{margin-top:8px;opacity:.75;font-size:16px;text-align:right}
    a{color:var(--accent);text-decoration:none;border-bottom:1px dotted var(--accent)}
    .hidden{display:none !important;}
    .updated{margin-top:6px;opacity:.65;font-size:14px;text-align:right}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Tomorrow’s Wind & Tide – Chalkboard</h1>
    <div class="sub">IST timezone. Wind: Open‑Meteo · Tides: WorldTides</div>
    <div class="controls" id="controls">
      <button class="btn active" data-view="both">Both</button>
      <button class="btn" data-view="havelock">Havelock</button>
      <button class="btn" data-view="neil">Neil</button>
    </div>
    <div class="grid" id="boards"></div>
    <div class="foot">DIVEIndia · Font sizes adjustable via CSS vars at top.</div>
  </div>
<script>
const LOCATIONS = [
  { key:'havelock', label:'Havelock / Swaraj Dweep', lat:11.968, lon:93.002 },
  { key:'neil',     label:'Neil / Shaheed Dweep',    lat:11.830, lon:93.017 }
];
function getTomorrowIST() {
  const now = new Date();
  const istOffsetMin = 5*60 + 30;
  const utc = now.getTime() + (now.getTimezoneOffset()*60000);
  const nowIST = new Date(utc + istOffsetMin*60000);
  const t = new Date(nowIST);
  t.setDate(t.getDate() + 1);
  t.setHours(0,0,0,0);
  return t;
}
function fmtDateHuman(d){ return d.toLocaleDateString('en-IN', { weekday:'short', day:'2-digit', month:'short', timeZone:'Asia/Kolkata' }); }
function fmtTimeIST(iso){
  const d = new Date(iso);
  return d.toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',hour12:true,timeZone:'Asia/Kolkata'});
}
function degToCompass(deg){
  const dirs = ['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSW','SW','WSW','W','WNW','NW','NNW'];
  return dirs[Math.round(deg/22.5) % 16];
}
const isSameISTDate = (iso, dateStr) => {
  const s = new Date(iso).toLocaleDateString('en-CA', { timeZone:'Asia/Kolkata' });
  return s === dateStr;
};

const boardsEl = document.getElementById('boards');
const tomorrowIST = getTomorrowIST();
const y = tomorrowIST.getFullYear();
const m = String(tomorrowIST.getMonth()+1).padStart(2,'0');
const d = String(tomorrowIST.getDate()).padStart(2,'0');
const tomorrowStr = `${y}-${m}-${d}`;

LOCATIONS.forEach(loc => {
  const board = document.createElement('div');
  board.className = 'board';
  board.dataset.key = loc.key;
  board.innerHTML = `
    <div class="title">
      <h2>${loc.label}</h2>
      <div class="date">${fmtDateHuman(tomorrowIST)} <span class="badge">Asia/Kolkata</span></div>
    </div>
    <div class="section">
      <div class="row"><div class="chip">Wind forecast (10 m)</div></div>
      <div class="wind-cards" id="wind-${loc.key}">
        <div class="card"><h4>Morning</h4><div class="big">—</div><div class="muted">06:00 IST</div></div>
        <div class="card"><h4>Noon</h4><div class="big">—</div><div class="muted">12:00 IST</div></div>
        <div class="card"><h4>Evening</h4><div class="big">—</div><div class="muted">18:00 IST</div></div>
      </div>
    </div>
    <div class="section">
      <div class="row"><div class="chip">Tides (High / Low)</div></div>
      <div class="tides" id="tide-${loc.key}"><div class="muted">Loading tides…</div></div>
    </div>
    <div class="updated" id="updated-${loc.key}"></div>
  `;
  boardsEl.appendChild(board);

  fetch(`/.netlify/functions/wind?lat=${loc.lat}&lon=${loc.lon}&date=${tomorrowStr}`)
    .then(r=>r.json())
    .then(data => { renderWind(loc.key, data); updateTime(loc.key); })
    .catch(e => setError(`wind-${loc.key}`, e));

  fetch(`/.netlify/functions/tides?lat=${loc.lat}&lon=${loc.lon}&date=${tomorrowStr}`)
    .then(r=>r.json())
    .then(data => { renderTides(loc.key, data, tomorrowStr); updateTime(loc.key); })
    .catch(e => setError(`tide-${loc.key}`, e));
});

function setError(id, e){
  const el = document.getElementById(id);
  if(!el) return;
  el.innerHTML = `<div class="err">Error: ${e?.message || e}</div>`;
}
function renderWind(key, data){
  const el = document.getElementById(`wind-${key}`);
  const slots = ['morning','noon','evening'];
  el.innerHTML = '';
  slots.forEach(s => {
    const w = data[s];
    const card = document.createElement('div');
    card.className = 'card';
    const when = s==='morning'?'06:00':(s==='noon'?'12:00':'18:00');
    card.innerHTML = `
      <h4>${s[0].toUpperCase()+s.slice(1)}</h4>
      <div class="big">
        ${Math.round(w.speed)} kn (gust ${Math.round(w.gust)} kn) · ${degToCompass(w.dir)}
      </div>
      <div class="muted">${when} IST</div>
    `;
    el.appendChild(card);
  });
}
function renderTides(key, data, dateStr){
  const el = document.getElementById(`tide-${key}`);
  el.innerHTML = '';
  let list = (data?.extremes || [])
    .filter(x => x?.timeISO && isSameISTDate(x.timeISO, dateStr))
    .sort((a,b) => new Date(a.timeISO) - new Date(b.timeISO));
  if (!list.length){
    el.innerHTML = `<div class="muted">No tide extremes found for this date.</div>`;
    return;
  }
  list = list.slice(0,4);
  list.forEach(t => {
    const item = document.createElement('div');
    item.className = 'card';
    const kind = t.type === 'High' ? 'High Tide' : 'Low Tide';
    item.innerHTML = `
      <div class="big">${kind}</div>
      <div class="muted">${fmtTimeIST(t.timeISO)} · ${typeof t.height === 'number' ? t.height.toFixed(2) : '—'} m</div>
    `;
    el.appendChild(item);
  });
}
function updateTime(key){
  const el = document.getElementById(`updated-${key}`);
  const now = new Date();
  el.textContent = `Last updated: ${now.toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' })}`;
}
// Toggle
const controls = document.getElementById('controls');
controls.addEventListener('click', (e)=>{
  const btn = e.target.closest('button[data-view]');
  if(!btn) return;
  controls.querySelectorAll('.btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  const view = btn.dataset.view;
  document.querySelectorAll('.board').forEach(b=>{
    const k = b.dataset.key;
    b.classList.toggle('hidden', !(view==='both' || view===k));
  });
});
</script>
</body>
</html>
